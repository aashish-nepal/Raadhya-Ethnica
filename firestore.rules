rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ───────────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Admin check: custom claim (set via Firebase Admin SDK) OR Firestore role field
    // on the user's OWN document (to avoid cross-user reads in rules)
    function isAdmin() {
      return isSignedIn() &&
        (request.auth.token.admin == true ||
         (request.auth.uid != null &&
          exists(/databases/$(database)/documents/customers/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/customers/$(request.auth.uid)).data.role == 'admin'));
    }

    // ─── Products ────────────────────────────────────────────────────────────
    // Public read; only admins can write
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ─── Orders ──────────────────────────────────────────────────────────────
    // Users see only their own orders; admins see all
    match /orders/{orderId} {
      allow read: if isSignedIn() &&
        (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() &&
        // Prevent userId spoofing: new order's userId must match the caller
        request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ─── Customers ───────────────────────────────────────────────────────────
    // FIXED: users can only read THEIR OWN document (was: all authenticated users)
    match /customers/{customerId} {
      allow read: if isOwner(customerId) || isAdmin();
      allow create: if isSignedIn() &&
        // Prevent creating a document with someone else's uid or with admin role
        customerId == request.auth.uid &&
        (!request.resource.data.keys().hasAny(['role']) ||
         request.resource.data.role == 'customer');
      allow update: if isSignedIn() && (
        // Users can update their OWN data but CANNOT change their role
        (isOwner(customerId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        // Admins can update anything
        isAdmin()
      );
      allow delete: if isAdmin();
    }

    // ─── Reviews ─────────────────────────────────────────────────────────────
    // Public read; authenticated create; own update/delete
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }

    // ─── Newsletter ───────────────────────────────────────────────────────────
    // Public create (guests can subscribe); admin can read list
    match /newsletter/{subscriberId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // ─── Coupons ─────────────────────────────────────────────────────────────
    // Public read (needed for checkout); admin write
    match /coupons/{couponId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ─── Carts ───────────────────────────────────────────────────────────────
    // Users can only access their own cart document
    match /carts/{cartId} {
      allow read, write: if isOwner(cartId);
    }

    // ─── Addresses ───────────────────────────────────────────────────────────
    // Users manage their own address sub-collection
    match /customers/{customerId}/addresses/{addressId} {
      allow read, write: if isOwner(customerId);
    }

    // ─── Settings ────────────────────────────────────────────────────────────
    // Public read (used on home page hero section); admin write only
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
